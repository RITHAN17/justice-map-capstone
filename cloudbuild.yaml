# cloudbuild.yaml: Defines the steps to build and push the container image

steps:
# 1. Build the Docker Image from the Dockerfile
- name: 'gcr.io/cloud-builders/docker'
  id: Build Image
  args:
    - 'build'
    - '-t'
    - 'gcr.io/$PROJECT_ID/justice-map-agent:$COMMIT_SHA'
    - '.'

# 2. Push the built container image to the Google Container Registry (GCR)
# This makes the image available for deployment on Cloud Run.
- name: 'gcr.io/cloud-builders/docker'
  id: Push Image
  args:
    - 'push'
    - 'gcr.io/$PROJECT_ID/justice-map-agent:$COMMIT_SHA'

# 3. Deploy the container image to Cloud Run (or Agent Engine)
# This step simulates the final deployment to a running service.
# Replace REGION with your desired GCP region (e.g., us-central1)
- name: 'gcr.io/cloud-builders/gcloud'
  id: Deploy to Cloud Run
  args:
    - 'run'
    - 'deploy'
    - 'justice-map-service'
    - '--image'
    - 'gcr.io/$PROJECT_ID/justice-map-agent:$COMMIT_SHA'
    - '--region'
    - 'us-central1'
    - '--platform'
    - 'managed'
    - '--allow-unauthenticated' # Allowing this for testing purposes
images:
- 'gcr.io/$PROJECT_ID/justice-map-agent:$COMMIT_SHA'
